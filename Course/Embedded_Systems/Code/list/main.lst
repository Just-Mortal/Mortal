C51 COMPILER V9.60.0.0   MAIN                                                              12/26/2024 09:05:37 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\list\main.obj
COMPILER INVOKED BY: D:\keil5\C51\BIN\C51.EXE main.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Config;.\Driver;.\Device;.\L
                    -ibrary) DEBUG PRINT(.\list\main.lst) TABS(2) OBJECT(.\list\main.obj)

line level    source

   1          #include "oled.h"
   2          
   3          
   4          bit B_1ms;
   5          
   6          #define QUEUE_LENGTH 10
   7          
   8          uint8 temp[4];
   9          uint16 msecond;
  10          uint8 voltage_queue[QUEUE_LENGTH] = {0};
  11          uint8 voltage_filtered; 
  12          uint8 measure_time = 0;
  13          uint8 freq_ctrl = 0; 
  14          
  15          void AddToQueue(uint8 value);
  16          uint8 GetFilteredVoltage();
  17          void OLED_DrawLine(uint8 x1, uint8 y1, uint8 x2, uint8 y2);
  18          
  19          void main(void)
  20          {
  21   1          uint8 i, voltage;
  22   1          uint8 prev_x = 0, prev_y = 0;
  23   1      
  24   1          EAXSFR();  
  25   1          GPIO_config();
  26   1          Timer_config();
  27   1          I2C_config();
  28   1          UART_config();
  29   1          ADC_config();
  30   1          EA = 1;
  31   1          OLED_Init();
  32   1      
  33   1          while (1)
  34   1          {
  35   2              if (B_1ms)
  36   2              {
  37   3                  B_1ms = 0;
  38   3                  freq_ctrl++;
  39   3      
  40   3                  // 读取电压值，范围是 0-1023，映射到 0-63
  41   3                  voltage = Get_ADCResult(i) / 16;
  42   3                  voltage = (voltage > 63) ? 63 : voltage;
  43   3      
  44   3                  AddToQueue(voltage);
  45   3                  voltage_filtered = GetFilteredVoltage();
  46   3      
  47   3                  measure_time = (measure_time >= 127) ? 0 : measure_time + 1;
  48   3      
  49   3                  if (measure_time > 0)
  50   3                    OLED_DrawLine(prev_x, prev_y, measure_time, voltage_filtered);
  51   3      
  52   3                  prev_x = measure_time;
  53   3                  prev_y = voltage_filtered;
  54   3              }
C51 COMPILER V9.60.0.0   MAIN                                                              12/26/2024 09:05:37 PAGE 2   

  55   2          }
  56   1      }
  57          
  58          void AddToQueue(uint8 value)
  59          {
  60   1        uint8 i;
  61   1      
  62   1        for (i = 0; i < QUEUE_LENGTH - 1; i++)
  63   1            voltage_queue[i] = voltage_queue[i + 1];  // 队列左移
  64   1        voltage_queue[QUEUE_LENGTH - 1] = value;      // 添加新值到队列末尾
  65   1      }
  66          
  67          uint8 GetFilteredVoltage()
  68          {
  69   1        uint8 i;
  70   1        uint16 sum = 0;
  71   1        for (i = 0; i < QUEUE_LENGTH; i++)
  72   1            sum += voltage_queue[i];
  73   1        return (uint8)(sum / QUEUE_LENGTH);           // 返回滤波后的电压值
  74   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    190    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     19       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
